# 音频设备配置说明

## 配置文件

音频设备在项目根目录的 `config.toml` 中配置:

```toml
# 音频设备配置
[audio]
capture_device  = "default"   # 录音（麦克风）设备
playback_device = "default"   # 播放（扬声器）设备
```

并且可以通过修改本地持久化配置文件`xiaozhi_config.json`来动态修改配置，无需再次编译:
```json
{
  "capture_device": "default",
  "playback_device": "default",
}
```

---

## 设备名称格式

ALSA 设备名称有以下几种常见格式：

| 格式 | 示例 | 说明 |
|---|---|---|
| `default` | `"default"` | ALSA 默认设备，由 `/etc/asound.conf` 决定 |
| `plughw:X,Y` | `"plughw:0,0"` | **推荐**。带插件层，自动处理采样率/格式转换，兼容性最佳 |
| `hw:X,Y` | `"hw:0,0"` | 直接访问硬件，不做任何转换，要求格式与硬件严格匹配 |
| `hw:CARDNAME,Y` | `"hw:rv1106acodec,0"` | 用声卡名称代替编号，可读性好，但依赖名称不变 |

> 其中 `X` 为声卡编号（card number），`Y` 为设备编号（device number）。

---

## 查询可用设备

在目标设备（嵌入式板卡）上执行以下命令查看可用的硬件设备：

**查询播放设备：**

```bash
aplay -l
```

**查询录音设备：**

```bash
arecord -l
```

**输出示例（LuckFox Pico）：**

```
**** List of PLAYBACK Hardware Devices ****
card 0: rv1106acodec [rv1106-acodec], device 0: ...
  Subdevices: 1/1
  Subdevice #0: subdevice #0

**** List of CAPTURE Hardware Devices ****
card 0: rv1106acodec [rv1106-acodec], device 0: ...
  Subdevices: 1/1
  Subdevice #0: subdevice #0
```

从输出可读出：`card 0`，`device 0`。

---

## 配置示例

### 使用默认设备

```toml
[audio]
capture_device  = "default"
playback_device = "default"
```

说明：`"default"` 是 ALSA 标准别名，会指向系统配置的默认声卡。在大多数情况下可以正常工作。

### 指定硬件设备

```toml
[audio]
capture_device  = "plughw:0,0"
playback_device = "plughw:0,0"
```

说明：明确指定 card 0, device 0，由 ALSA `plug` 插件处理采样率和格式适配。

### 输入输出使用不同设备

```toml
[audio]
capture_device  = "plughw:1,0"   # 外接 USB 麦克风（card 1）
playback_device = "plughw:0,0"   # 板载扬声器（card 0）
```

---

## `default` 与 `plughw` 的选择建议

| 场景 | 推荐设置 |
|---|---|
| 标准 Linux 桌面，系统已配置好音频 | `"default"` |
| 嵌入式 Linux / 无桌面环境 | `"plughw:0,0"` |
| 遇到 `Failed to open PCM device` 错误 | 改用 `"plughw:0,0"` |
| 需要同时被多个进程共享声卡 | `"default"`（走 dmix/dsnoop）|

---

## 内部实现说明

配置中的设备名称字符串会被**直接传递**给 ALSA 的 `PCM::new()` 接口（见 `audio/src/alsa_device.rs`），程序本身不做任何转换或解析，填写时需确保设备名称为合法的 ALSA PCM 设备名。
